
!function()
{
	"use strict";
	function ResizeAreas()
	{
		function Resize(event)
		{
			// process all areas
			var i=0;
			for(i=0; i<areas.length; i++)
			{
				// get old coordinates
				var coords = areas[i].getAttribute("data-org_coords").split(",");

				// get factors
				var factorX = image.width / image.naturalWidth;
				var factorY = image.height / image.naturalHeight;
				
				// calculate new coordinates
				coords[0] = coords[0] * factorX;
				coords[2] = coords[2] * factorX;
				
				coords[1] = coords[1] * factorY;
				coords[3] = coords[3] * factorY;
				
				areas[i].coords = coords.join(",");
			}
		}
		
		// get the image map
		var imgMap=this;
		var areas=null;
		
		areas=imgMap.getElementsByTagName("area");
		
		var i=0;
		for(i=0; i<areas.length; i++)
		{
			areas[i].coords.replace(/ *, */g,",").replace(/ +/g,",")
		}

		var image = document.querySelector('img[usemap="#'+imgMap.name+'"]');
		
		// add event listeners to the image, the window and document
		image.addEventListener("onload", Resize, true);
		window.addEventListener("focus", Resize, true);
		window.addEventListener("resize", Resize, true);
		document.addEventListener("fullscreenchange", Resize, true);	

		Resize();
	}
	

	// define the resize function
	"jQuery" in window&&(jQuery.fn.ResizeImageMap=function()
	{
		return this.filter("map").each(ResizeAreas).end();
	})
	
	function Highlight()
	{
		function highlightArea(event)
		{
			// get the area that should be highlighted
			var area = event.target;
			var area_coords = area.coords.split(",");
			
			var canvas = document.querySelector('canvas[id^="canvas_' + image.id +'"]');
			canvas.width = image.width;
			canvas.height = image.height;
			
			if(canvas.getContext("2d"))
			{
				// get factors
				var factorX = image.width / image.naturalWidth;
				var factorY = image.height / image.naturalHeight;
				
				var rect_left 	= area_coords[0];// * factorX;
				var rect_top 	= area_coords[1];// * factorY;
				var rect_right 	= (area_coords[2]-area_coords[0]);// * factorX;
				var rect_bottom	= (area_coords[3]-area_coords[1]);// * factorY;
				
				var ctx = canvas.getContext("2d");

				ctx.fillStyle= area.getAttribute("data-color_highlight");
				ctx.fillRect(rect_left, rect_top, rect_right, rect_bottom);
				
				ctx.strokeRect(rect_left, rect_top, rect_right, rect_bottom);
			}
		}
		
		function showText(event)
		{
			var area = event.target;
			
			var textboxName 	= area.getAttribute("data-textbox");
			var textboxContents	= area.getAttribute("data-textbox_contents");
			var textbox = document.querySelector('div[id^='+textboxName+']');
			$(textbox).html(textboxContents);
		}
		
		// get the image map
		var imgMap=this;
		var image = document.querySelector('img[usemap="#'+imgMap.name+'"]');
		var areas=null;
		
		// get image map areas
		areas=imgMap.getElementsByTagName("area");
	
		// check if any of them have a mouse over event
		var i=0;
		for(i=0; i<areas.length; i++)
		{
			$(areas[i]).mouseover(highlightArea);
			$(areas[i]).click(showText);
		}
	}
	
	"jQuery" in window&&(jQuery.fn.Highlight=function()
	{
		return this.filter("map").each(Highlight).end();
	})
}();